<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Agent Dashboard | Mumbai Realty</title>
  <meta name="robots" content="noindex,nofollow" />

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../css/style.css" />
  <style>
    body { background: var(--off); }
    .dash-layout { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; flex-shrink: 0; background: var(--navy); display: flex; flex-direction: column; }
    .main-content { flex: 1; overflow-x: auto; }
    @media(max-width:768px) {
      .dash-layout { flex-direction: column; }
      .sidebar { width: 100%; }
    }
    .prop-table img { width:60px; height:45px; object-fit:cover; border-radius:6px; }
    .prop-table td { vertical-align: middle; font-size: 0.88rem; }
    .inquiry-item { border-left: 3px solid var(--sky); padding: 14px 16px; background: #fff; border-radius: 0 8px 8px 0; margin-bottom: 12px; box-shadow: var(--shadow); }
    .inquiry-item .prop-ref { font-size: 0.78rem; color: var(--sky); }
    .inquiry-item .name { font-weight: 600; }
    .inquiry-item .contact { font-size: 0.82rem; color: var(--gray); }
    .tab-content-area { display: none; }
    .tab-content-area.active { display: block; }
    .nav-tabs-custom { border-bottom: 2px solid var(--border); margin-bottom: 24px; }
    .nav-tabs-custom .nav-link { border: none; color: var(--gray); font-weight: 500; padding: 10px 20px; border-radius: 0; }
    .nav-tabs-custom .nav-link.active { color: var(--sky); border-bottom: 3px solid var(--sky); background: none; }
  </style>
</head>
<body>

<div class="page-loader" id="pageLoader">
  <div class="loader-logo">Mumbai <span>Realty</span></div>
  <div class="loader-ring"></div>
</div>

<div class="dash-layout">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <div class="dash-logo">
      <i class="fas fa-building me-2"></i>Mumbai <span style="color:#fff;">Realty</span>
    </div>
    <div style="padding:16px 24px;border-bottom:1px solid rgba(255,255,255,0.1);">
      <div style="color:rgba(255,255,255,0.5);font-size:0.75rem;text-transform:uppercase;letter-spacing:2px;">Agent Portal</div>
      <div id="agentEmail" style="color:var(--gold);font-size:0.85rem;margin-top:4px;">Loading…</div>
    </div>
    <nav class="dash-nav mt-2">
      <div class="nav flex-column">
        <a href="#" class="nav-link active" onclick="showTab('overview', this)"><i class="fas fa-tachometer-alt"></i> Overview</a>
        <a href="#" class="nav-link" onclick="showTab('properties', this)"><i class="fas fa-home"></i> Properties</a>
        <a href="#" class="nav-link" onclick="showTab('inquiries', this)"><i class="fas fa-envelope"></i> Inquiries</a>
        <a href="#" class="nav-link" onclick="showTab('add', this)"><i class="fas fa-plus-circle"></i> Add Property</a>
        <hr style="border-color:rgba(255,255,255,0.1);margin:8px 0;" />
        <a href="../index.html" class="nav-link"><i class="fas fa-external-link-alt"></i> View Website</a>
        <a href="#" class="nav-link" onclick="logout()" style="color:#f87171!important;"><i class="fas fa-sign-out-alt"></i> Logout</a>
      </div>
    </nav>
  </div>

  <!-- MAIN -->
  <div class="main-content dash-main">
    <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
      <div>
        <h4 style="font-family:'Playfair Display',serif;font-weight:700;margin:0;">Agent Dashboard</h4>
        <p class="text-muted mb-0" style="font-size:0.85rem;" id="dateLabel"></p>
      </div>
      <button class="btn btn-gold px-4" onclick="showTab('add', document.querySelector('.dash-nav .nav-link:nth-child(4)'))">
        <i class="fas fa-plus me-2"></i>Add Property
      </button>
    </div>

    <!-- OVERVIEW -->
    <div class="tab-content-area active" id="tab-overview">
      <div class="row g-4 mb-4">
        <div class="col-md-3 col-6">
          <div class="stat-card">
            <div style="font-size:2rem;margin-bottom:4px;"><i class="fas fa-home"></i></div>
            <div class="s-num" id="statTotal">—</div>
            <div style="color:rgba(255,255,255,0.7);font-size:0.85rem;">Total Properties</div>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="stat-card" style="background:linear-gradient(135deg,#16a34a,#15803d);">
            <div style="font-size:2rem;margin-bottom:4px;"><i class="fas fa-tag"></i></div>
            <div class="s-num" id="statSale">—</div>
            <div style="color:rgba(255,255,255,0.7);font-size:0.85rem;">For Sale</div>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="stat-card gold">
            <div style="font-size:2rem;margin-bottom:4px;"><i class="fas fa-check-circle"></i></div>
            <div class="s-num" id="statSold">—</div>
            <div style="font-size:0.85rem;opacity:0.75;">Sold</div>
          </div>
        </div>
        <div class="col-md-3 col-6">
          <div class="stat-card dark">
            <div style="font-size:2rem;margin-bottom:4px;color:var(--gold);"><i class="fas fa-envelope"></i></div>
            <div class="s-num" id="statInquiries">—</div>
            <div style="color:rgba(255,255,255,0.7);font-size:0.85rem;">Inquiries</div>
          </div>
        </div>
      </div>

      <!-- Recent Properties -->
      <div class="dash-card">
        <h5 class="fw-bold mb-3"><i class="fas fa-clock text-primary me-2"></i>Recent Properties</h5>
        <div id="recentProps"><div class="text-center py-4"><div class="loader-ring mx-auto"></div></div></div>
      </div>
    </div>

    <!-- PROPERTIES LIST -->
    <div class="tab-content-area" id="tab-properties">
      <div class="dash-card">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h5 class="fw-bold mb-0"><i class="fas fa-home text-primary me-2"></i>All Properties</h5>
          <input type="text" class="form-control form-control-sm" style="width:220px;" placeholder="Search properties…" id="propSearch" oninput="filterDashProps()" />
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle prop-table">
            <thead style="background:var(--off);">
              <tr>
                <th>Image</th><th>Title</th><th>Price</th><th>Location</th><th>Type</th><th>Status</th><th>Actions</th>
              </tr>
            </thead>
            <tbody id="propsTableBody"><tr><td colspan="7" class="text-center py-4"><div class="loader-ring mx-auto"></div></td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- INQUIRIES -->
    <div class="tab-content-area" id="tab-inquiries">
      <div class="dash-card">
        <h5 class="fw-bold mb-4"><i class="fas fa-envelope text-primary me-2"></i>All Inquiries</h5>
        <div id="inquiriesList"><div class="text-center py-4"><div class="loader-ring mx-auto"></div></div></div>
      </div>
    </div>

    <!-- ADD / EDIT PROPERTY FORM -->
    <div class="tab-content-area" id="tab-add">
      <div class="dash-card">
        <h5 class="fw-bold mb-4" id="formTitle"><i class="fas fa-plus-circle text-primary me-2"></i>Add New Property</h5>
        <form id="propForm">
          <input type="hidden" id="editDocId" />
          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">Property Title *</label>
              <input type="text" class="form-control" id="fTitle" placeholder="e.g. 2BHK Flat in Andheri West" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Price (₹) *</label>
              <input type="number" class="form-control" id="fPrice" placeholder="e.g. 7500000" required />
            </div>
            <div class="col-md-4">
              <label class="form-label">Location *</label>
              <select class="form-select" id="fLocation" required>
                <option value="">Select Location</option>
                <option>Andheri</option><option>Borivali</option><option>Virar</option>
                <option>Bandra</option><option>Mira Road</option><option>Kandivali</option>
                <option>Dahisar</option><option>Malad</option><option>Goregaon</option>
                <option>Kurla</option><option>Thane</option><option>Navi Mumbai</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Property Type *</label>
              <select class="form-select" id="fType" required>
                <option value="">Select Type</option>
                <option>Flat</option><option>Shop</option><option>Office</option><option>Plot</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Status</label>
              <select class="form-select" id="fStatus">
                <option value="For Sale">For Sale</option>
                <option value="Sold">Sold</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Area (sq ft)</label>
              <input type="number" class="form-control" id="fArea" placeholder="e.g. 850" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Bedrooms</label>
              <select class="form-select" id="fBedrooms">
                <option value="">Select</option>
                <option>1</option><option>2</option><option>3</option><option>4</option><option>5+</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Bathrooms</label>
              <select class="form-select" id="fBathrooms">
                <option value="">Select</option>
                <option>1</option><option>2</option><option>3</option><option>4</option>
              </select>
            </div>
            <div class="col-12">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="fDescription" rows="4" placeholder="Describe the property in detail…"></textarea>
            </div>
            <div class="col-12">
              <label class="form-label">Property Image URL</label>
              <input type="url" class="form-control" id="fImage" placeholder="https://… (paste a direct image link)" />
              <div class="form-text">Paste a direct image URL. Recommended: Upload to <a href="https://imgur.com" target="_blank">imgur.com</a> or <a href="https://imgbb.com" target="_blank">imgbb.com</a> and paste the link.</div>
            </div>
            <!-- Preview -->
            <div class="col-12" id="imgPreviewWrap" style="display:none;">
              <label class="form-label">Image Preview</label>
              <img id="imgPreview" src="" alt="Preview" style="max-height:200px;border-radius:8px;border:1.5px solid var(--border);" />
            </div>
          </div>

          <div class="d-flex gap-3 mt-4">
            <button type="submit" class="btn btn-navy px-5 py-2 fw-bold" id="saveBtn">
              <i class="fas fa-save me-2"></i>Save Property
            </button>
            <button type="button" class="btn btn-outline-secondary px-4 py-2" onclick="resetForm()">
              <i class="fas fa-times me-2"></i>Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

  </div><!-- /main-content -->
</div><!-- /dash-layout -->

<!-- Delete Confirm Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content" style="border-radius:14px;">
      <div class="modal-body text-center p-4">
        <i class="fas fa-trash-alt text-danger" style="font-size:2.5rem;"></i>
        <h5 class="mt-3 fw-bold">Delete Property?</h5>
        <p class="text-muted">This cannot be undone.</p>
        <div class="d-flex gap-2 justify-content-center">
          <button class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-danger px-4" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="../js/firebase-config.js"></script>
<script src="../js/main.js"></script>
<script>
  let allProps = [], allInquiries = [];
  let deleteModal, pendingDeleteId = null;

  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(hideLoader, 600);
    document.getElementById('dateLabel').textContent = new Date().toLocaleDateString('en-IN', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

    // Auth guard
    auth.onAuthStateChanged(user => {
      if (!user || user.email !== AGENT_EMAIL) {
        window.location.href = 'login.html';
        return;
      }
      document.getElementById('agentEmail').textContent = user.email;
      loadData();
    });

    // Image preview
    document.getElementById('fImage').addEventListener('input', function() {
      const wrap = document.getElementById('imgPreviewWrap');
      const img  = document.getElementById('imgPreview');
      if (this.value) { img.src = this.value; wrap.style.display = 'block'; }
      else { wrap.style.display = 'none'; }
    });

    document.getElementById('propForm').addEventListener('submit', saveProperty);
    document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDelete);
  });

  function showTab(name, el) {
    document.querySelectorAll('.tab-content-area').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.dash-nav .nav-link').forEach(a => a.classList.remove('active'));
    document.getElementById(`tab-${name}`).classList.add('active');
    if (el) el.classList.add('active');
  }

  async function loadData() {
    try {
      // Properties
      const pSnap = await db.collection('properties').orderBy('createdAt','desc').get();
      allProps = pSnap.docs.map(d => ({ id:d.id, ...d.data() }));

      // Inquiries
      const iSnap = await db.collection('inquiries').orderBy('createdAt','desc').get();
      allInquiries = iSnap.docs.map(d => ({ id:d.id, ...d.data() }));

      renderStats();
      renderRecentProps();
      renderPropsTable();
      renderInquiries();
    } catch(err) {
      console.error(err);
      showToast('Error loading data. Check Firebase config.', 'error');
    }
  }

  function renderStats() {
    const forSale = allProps.filter(p => p.status !== 'Sold').length;
    const sold    = allProps.filter(p => p.status === 'Sold').length;
    document.getElementById('statTotal').textContent      = allProps.length;
    document.getElementById('statSale').textContent       = forSale;
    document.getElementById('statSold').textContent       = sold;
    document.getElementById('statInquiries').textContent  = allInquiries.length;
  }

  function renderRecentProps() {
    const el = document.getElementById('recentProps');
    if (!allProps.length) { el.innerHTML = '<div class="empty-state"><i class="fas fa-home"></i><p>No properties yet.</p></div>'; return; }
    const recent = allProps.slice(0, 5);
    el.innerHTML = `<table class="table table-hover prop-table"><thead><tr><th>Image</th><th>Title</th><th>Price</th><th>Location</th><th>Status</th></tr></thead><tbody>
      ${recent.map(p => `<tr>
        <td><img src="${p.image||'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=200&q=60'}" onerror="this.src='https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=200&q=60'" /></td>
        <td>${p.title}</td>
        <td class="text-primary fw-bold">${formatPrice(p.price)}</td>
        <td>${p.location}</td>
        <td><span class="badge ${p.status==='Sold'?'bg-danger':'bg-primary'}">${p.status||'For Sale'}</span></td>
      </tr>`).join('')}
    </tbody></table>`;
  }

  function renderPropsTable(filter = '') {
    const tbody = document.getElementById('propsTableBody');
    let props = allProps;
    if (filter) props = props.filter(p => p.title.toLowerCase().includes(filter) || p.location.toLowerCase().includes(filter));
    if (!props.length) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state text-center py-4">No properties found.</td></tr>'; return; }
    tbody.innerHTML = props.map(p => `
      <tr>
        <td><img src="${p.image||'https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=200&q=60'}" onerror="this.src='https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=200&q=60'" /></td>
        <td><strong>${p.title}</strong></td>
        <td class="text-primary fw-bold">${formatPrice(p.price)}</td>
        <td>${p.location}</td>
        <td><span class="badge" style="background:var(--sky);">${p.type||'Flat'}</span></td>
        <td><span class="badge ${p.status==='Sold'?'bg-danger':'bg-success'}">${p.status||'For Sale'}</span></td>
        <td>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-primary" onclick="editProperty('${p.id}')"><i class="fas fa-edit"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteProperty('${p.id}')"><i class="fas fa-trash"></i></button>
            <a href="property-detail.html?id=${p.id}" target="_blank" class="btn btn-sm btn-outline-secondary"><i class="fas fa-eye"></i></a>
          </div>
        </td>
      </tr>`).join('');
  }

  function filterDashProps() {
    const q = document.getElementById('propSearch').value.toLowerCase();
    renderPropsTable(q);
  }

  function renderInquiries() {
    const el = document.getElementById('inquiriesList');
    if (!allInquiries.length) { el.innerHTML = '<div class="empty-state"><i class="fas fa-envelope"></i><p>No inquiries yet.</p></div>'; return; }
    el.innerHTML = allInquiries.map(i => {
      const date = i.createdAt?.toDate ? i.createdAt.toDate().toLocaleDateString('en-IN') : '—';
      return `<div class="inquiry-item">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div>
            <div class="prop-ref"><i class="fas fa-home me-1"></i>${i.propertyTitle||'Unknown Property'}</div>
            <div class="name mt-1">${i.name}</div>
            <div class="contact mt-1">
              <a href="tel:${i.phone}" class="me-3"><i class="fas fa-phone me-1"></i>${i.phone}</a>
              <a href="mailto:${i.email}"><i class="fas fa-envelope me-1"></i>${i.email}</a>
            </div>
            ${i.message ? `<div class="mt-2" style="font-size:0.85rem;color:var(--gray);">"${i.message}"</div>` : ''}
          </div>
          <div class="text-muted" style="font-size:0.78rem;white-space:nowrap;">${date}</div>
        </div>
      </div>`;
    }).join('');
  }

  function editProperty(id) {
    const p = allProps.find(x => x.id === id);
    if (!p) return;
    document.getElementById('editDocId').value = id;
    document.getElementById('fTitle').value       = p.title||'';
    document.getElementById('fPrice').value       = p.price||'';
    document.getElementById('fLocation').value    = p.location||'';
    document.getElementById('fType').value        = p.type||'';
    document.getElementById('fStatus').value      = p.status||'For Sale';
    document.getElementById('fArea').value        = p.area||'';
    document.getElementById('fBedrooms').value    = p.bedrooms||'';
    document.getElementById('fBathrooms').value   = p.bathrooms||'';
    document.getElementById('fDescription').value = p.description||'';
    document.getElementById('fImage').value       = p.image||'';
    if (p.image) {
      document.getElementById('imgPreview').src      = p.image;
      document.getElementById('imgPreviewWrap').style.display = 'block';
    }
    document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit text-primary me-2"></i>Edit Property';
    showTab('add', document.querySelector('.dash-nav .nav-link:nth-child(4)'));
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function deleteProperty(id) {
    pendingDeleteId = id;
    deleteModal.show();
  }

  async function confirmDelete() {
    if (!pendingDeleteId) return;
    try {
      await db.collection('properties').doc(pendingDeleteId).delete();
      allProps = allProps.filter(p => p.id !== pendingDeleteId);
      renderStats(); renderRecentProps(); renderPropsTable();
      showToast('Property deleted successfully.', 'success');
    } catch(err) {
      showToast('Error deleting property.', 'error');
    } finally {
      deleteModal.hide();
      pendingDeleteId = null;
    }
  }

  async function saveProperty(e) {
    e.preventDefault();
    const btn = document.getElementById('saveBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving…';

    const editId = document.getElementById('editDocId').value;
    const data = {
      title:       document.getElementById('fTitle').value.trim(),
      price:       Number(document.getElementById('fPrice').value),
      location:    document.getElementById('fLocation').value,
      type:        document.getElementById('fType').value,
      status:      document.getElementById('fStatus').value,
      area:        document.getElementById('fArea').value || '',
      bedrooms:    document.getElementById('fBedrooms').value || '',
      bathrooms:   document.getElementById('fBathrooms').value || '',
      description: document.getElementById('fDescription').value.trim(),
      image:       document.getElementById('fImage').value.trim(),
    };

    try {
      if (editId) {
        await db.collection('properties').doc(editId).update(data);
        showToast('Property updated successfully!', 'success');
        const idx = allProps.findIndex(p => p.id === editId);
        if (idx > -1) allProps[idx] = { id:editId, ...allProps[idx], ...data };
      } else {
        data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
        const ref = await db.collection('properties').add(data);
        allProps.unshift({ id:ref.id, ...data });
        showToast('Property added successfully!', 'success');
      }
      renderStats(); renderRecentProps(); renderPropsTable();
      resetForm();
      showTab('properties', document.querySelector('.dash-nav .nav-link:nth-child(2)'));
    } catch(err) {
      console.error(err);
      showToast('Error saving property.', 'error');
    } finally {
      btn.disabled = false;
      btn.innerHTML = '<i class="fas fa-save me-2"></i>Save Property';
    }
  }

  function resetForm() {
    document.getElementById('propForm').reset();
    document.getElementById('editDocId').value = '';
    document.getElementById('formTitle').innerHTML = '<i class="fas fa-plus-circle text-primary me-2"></i>Add New Property';
    document.getElementById('imgPreviewWrap').style.display = 'none';
  }
</script>
</body>
</html>
